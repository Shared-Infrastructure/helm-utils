name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      HAS_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Import GPG key (Optional)
        if: env.HAS_GPG_KEY == 'true'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --import --batch --yes
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
            gpg-connect-agent reloadagent /bye
          fi
          # Export to legacy keyring format for Helm compatibility
          gpg --batch --yes --export > ~/.gnupg/pubring.gpg
          if [ -n "$GPG_PASSPHRASE" ]; then
            gpg --batch --yes --passphrase "$GPG_PASSPHRASE" --pinentry-mode loopback --export-secret-keys > ~/.gnupg/secring.gpg
          else
            gpg --batch --yes --pinentry-mode loopback --export-secret-keys > ~/.gnupg/secring.gpg
          fi

      - name: Package Helm Charts
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_NAME: ${{ secrets.GPG_KEY_NAME }}
        run: |
          for chart in charts/*; do
            if [ -d "$chart" ]; then
              if [ "$HAS_GPG_KEY" = "true" ]; then
                echo "Signing chart: $chart"
                if [ -n "$GPG_PASSPHRASE" ]; then
                  echo "$GPG_PASSPHRASE" | helm package --sign --key "$GPG_KEY_NAME" --keyring ~/.gnupg/secring.gpg "$chart" -d docs/
                else
                  helm package --sign --key "$GPG_KEY_NAME" --keyring ~/.gnupg/secring.gpg "$chart" -d docs/
                fi
              else
                echo "Packaging chart (unsigned): $chart"
                helm package "$chart" -d docs/
              fi
            fi
          done

      - name: Export GPG public key (if signing enabled)
        if: env.HAS_GPG_KEY == 'true'
        env:
          GPG_KEY_NAME: ${{ secrets.GPG_KEY_NAME }}
        run: |
          gpg --armor --export "$GPG_KEY_NAME" > docs/gpg-public-key.asc
          echo "Public key exported"

      - name: Generate Index
        run: |
          helm repo index docs/ --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

      - name: Commit and Push Changes
        run: |
          git add docs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "$HAS_GPG_KEY" = "true" ]; then
              git commit -m "Release signed Helm charts [skip ci]"
            else
              git commit -m "Release Helm charts [skip ci]"
            fi
            git push
          fi


